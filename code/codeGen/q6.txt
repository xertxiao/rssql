CREATE STREAM pub (Ts: timestamp, PaperId: int, PaperRef: int) CREATE RELATION totalRef (Ts, PaperId, count() AS R) AS (SELECT Ts, PaperId, PaperRef FROM pub) WITH recursive prank (Ts, P, sum() AS V) AS (SELECT Ts, P, 1.0 FROM totalRef) UNION (SELECT greatest(prank.Ts, pub.Ts, totalRef.Ts), pub.PapertotalRef, prank.V / totalRef.R FROM totalRef, pub, prank WHERE prank.P = pub.PaperId, prank.P = totalRef.PaperId) SELECT P, R FROM prank WINDOW[360, 30]